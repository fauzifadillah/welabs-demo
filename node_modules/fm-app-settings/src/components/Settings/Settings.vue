<script>
import { Session } from '../../utils/settings'
import listenOnRootMixin from '../../mixins/listen-on-root'
import Collapse from './Collapse.vue'
import { BvFormImageGroup as FormImageGroup } from 'bv-form-image-group'
// import 'fmv-layout/dist/fmv-layout.css'

export default {
  mixins: [
    listenOnRootMixin,
  ],
  components: {
    Collapse,
    FormImageGroup
  },
  data() {
    return {
      session: null,
      settings: {},
    }
  },
  props: {
    namespace: {
      type: String,
      default: null
    },
    options: {
      type: Array,
      required: true
    },
    debug: {
      type: Boolean,
      default: false
    }
  },
  watch: {
    settings: {
      deep: true,
      handler(value) {
        this.setSettings()
      }
    }
  },
  mounted() {
    this.session = new Session(this.namespace)
    this.initSettings()
    this.listenOnRoot('fm:settings:update', this.onUpdate)
  },
  methods: {
    onUpdate(settings) {
      Object.keys(settings).map(key => {
        this.$set(this.settings, key, settings[key])
      })
    },
    initSettings() {
      let memory = this.session.memory('settings')

      this.options.forEach(option => {
        option.children.forEach(group => {
          if (this.settings[`${option.id}.${group.id}`] === undefined) {
            let value

            if (group.cookies === undefined || group.cookies !== false) {
              try {
                value = memory[`${option.id}.${group.id}`]
              } catch(e) {}
            }
            
            const def = group.options.find(o => o.selected === true)
            if (!value && def !== undefined) {
              value = def.value
            }
            if (!value && value !== false) {
              value = group.options[0].value
            }

            this.$set(this.settings, `${option.id}.${group.id}`, value)
          }
        })
      })
    },
    setSettings(reload) {
      this.session.save('settings', this.settings)

      this.$root.$emit('fm:settings:state', this.settings)

      if (reload) {
        location.reload()
      }
    }
  }
}
</script>
